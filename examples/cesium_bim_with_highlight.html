<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <!-- Include the CesiumJS JavaScript and CSS files -->
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.127/Build/Cesium/Cesium.js"></script>
    <link
      href="https://cesium.com/downloads/cesiumjs/releases/1.127/Build/Cesium/Widgets/widgets.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div id="cesiumContainer"></div>
    <script src="./set_env_variables.js"></script>
    <script type="module">
      Cesium.Ion.defaultAccessToken = window.env.CESIUM_ION_TOKEN_AQIB;
      const wsdAssetId = window.env.cesium_ion_assets.wsd;
      const googleAssetId = window.env.cesium_ion_assets.wsd;

      const viewer = new Cesium.Viewer("cesiumContainer", {
        globe: false,
      });

      // Add Photorealistic 3D tiles
      let googleTileset;
      try {
        googleTileset = await Cesium.Cesium3DTileset.fromIonAssetId(
          googleAssetId
        );
        // viewer.scene.primitives.add(googleTileset);
      } catch (error) {
        console.log(`Error loading tileset: ${error}`);
      }
      let bimTileset;
      try {
        bimTileset = await Cesium.Cesium3DTileset.fromIonAssetId(wsdAssetId);
        viewer.scene.primitives.add(bimTileset);
        bimTileset.show = true;
        await viewer.zoomTo(bimTileset);
      } catch (error) {
        console.log(`Error loading tileset: ${error}`);
      }

      const clickHandler = viewer.screenSpaceEventHandler.getInputAction(
        Cesium.ScreenSpaceEventType.LEFT_CLICK
      );

      // Create the HTML that will be put into the info box that shows
      // information about the currently selected feature
      function createPickedFeatureDescription(pickedFeature) {
        let description = `${'<table class="cesium-infoBox-defaultTable"><tbody>'}`;

        const propertyIds = pickedFeature.getPropertyIds();

        // Sort properties alphabetically
        propertyIds.sort((a, b) => a.localeCompare(b));

        const length = propertyIds.length;
        for (let i = 0; i < length; ++i) {
          const propertyId = propertyIds[i];
          const propertyValue = pickedFeature.getProperty(propertyId);

          // Reject properties with default values
          if (Cesium.defined(propertyValue) && propertyValue !== "") {
            description += `<tr><th>${propertyId}</th><td>${propertyValue}</td></tr>`;
          }
        }

        description += `</tbody></table>`;

        return description;
      }

      // An entity object which will hold info about the currently selected feature for infobox display
      const selectedEntity = new Cesium.Entity();

      // Information about the currently selected feature
      const selected = {
        feature: undefined,
        originalColor: new Cesium.Color(),
      };

      // Information about the currently highlighted feature
      const highlighted = {
        feature: undefined,
        originalColor: new Cesium.Color(),
      };

      // Color a feature yellow on hover.
      viewer.screenSpaceEventHandler.setInputAction(function onMouseMove(
        movement
      ) {
        // If a feature was previously highlighted, undo the highlight
        if (Cesium.defined(highlighted.feature)) {
          highlighted.feature.color = highlighted.originalColor;
          highlighted.feature = undefined;
        }
        // Pick a new feature
        const pickedFeature = viewer.scene.pick(movement.endPosition);

        if (
          !Cesium.defined(pickedFeature) ||
          !(pickedFeature instanceof Cesium.Cesium3DTileFeature)
        ) {
          return;
        }

        // Highlight the feature if it's not already selected.
        if (pickedFeature !== selected.feature) {
          highlighted.feature = pickedFeature;
          Cesium.Color.clone(pickedFeature.color, highlighted.originalColor);
          pickedFeature.color = Cesium.Color.YELLOW;
        }
      },
      Cesium.ScreenSpaceEventType.MOUSE_MOVE);

      // Color a feature on selection and show metadata in the InfoBox.
      viewer.screenSpaceEventHandler.setInputAction(function onLeftClick(
        movement
      ) {
        // If a feature was previously selected, undo the highlight
        if (Cesium.defined(selected.feature)) {
          selected.feature.color = selected.originalColor;
          selected.feature = undefined;
        }
        // Pick a new feature
        const pickedFeature = viewer.scene.pick(movement.position);
        if (
          !Cesium.defined(pickedFeature) ||
          !(pickedFeature instanceof Cesium.Cesium3DTileFeature)
        ) {
          clickHandler(movement);
          return;
        }
        // Select the feature if it's not already selected
        if (selected.feature === pickedFeature) {
          return;
        }
        selected.feature = pickedFeature;
        // Save the selected feature's original color
        if (pickedFeature === highlighted.feature) {
          Cesium.Color.clone(highlighted.originalColor, selected.originalColor);
          highlighted.feature = undefined;
        } else {
          Cesium.Color.clone(pickedFeature.color, selected.originalColor);
        }
        // Highlight newly selected feature
        pickedFeature.color = Cesium.Color.LIME;

        // Set feature infobox description
        viewer.selectedEntity = selectedEntity;
        selectedEntity.description =
          createPickedFeatureDescription(pickedFeature);
      },
      Cesium.ScreenSpaceEventType.LEFT_CLICK);
    </script>
  </body>
</html>
